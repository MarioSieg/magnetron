<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MNIST Digit Recognizer</title>
    <style>
        #canvas {
            border: 1px solid #000;
            touch-action: none;
        }
    </style>
</head>
<body>
    <h1>Draw a digit</h1>
    <canvas id="canvas" width="280" height="280"></canvas>
    <br>
    <button id="clearBtn">Clear</button>
    <button id="predictBtn">Predict</button>
    <h2 id="result"></h2>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = "white";
        ctx.lineWidth = 15;
        ctx.lineCap = "round";

        canvas.addEventListener('mousedown', function(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });
        canvas.addEventListener('mousemove', function(e) {
            if (drawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        });
        canvas.addEventListener('mouseup', function() { drawing = false; });
        canvas.addEventListener('mouseout', function() { drawing = false; });
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            let touch = e.touches[0];
            let rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            drawing = true;
        });
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (drawing) {
                let touch = e.touches[0];
                let rect = canvas.getBoundingClientRect();
                ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                ctx.stroke();
            }
        });
        canvas.addEventListener('touchend', function() { drawing = false; });
        document.getElementById('clearBtn').addEventListener('click', function() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            document.getElementById('result').innerText = "";
        });
        document.getElementById('predictBtn').addEventListener('click', function() {
            const dataURL = canvas.toDataURL('image/png');
            fetch('/predict/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'image=' + encodeURIComponent(dataURL)
            })
            .then(response => response.json())
            .then(data => {
                if (data.prediction !== undefined) {
                    document.getElementById('result').innerText = "Predicted digit: " + data.prediction;
                } else {
                    document.getElementById('result').innerText = "Error: " + JSON.stringify(data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>